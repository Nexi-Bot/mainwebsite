<!DOCTYPE html>
<html>
<head>
    <title>Payment Test - Fixed Authentication</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .button { padding: 10px 20px; margin: 10px; background: #007cba; color: white; text-decoration: none; border-radius: 5px; display: inline-block; cursor: pointer; border: none; }
        .button:hover { background: #005a87; }
        .debug { background: #333; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <h1>Payment Authentication Test</h1>
    
    <div class="debug" id="status">Click "Start Test" to begin...</div>
    
    <button onclick="runFullTest()" class="button">Start Full Test</button>
    <button onclick="testAuthOnly()" class="button">Test Auth Only</button>
    <button onclick="testAuthEndpoint()" class="button">Test Auth Endpoint</button>
    <button onclick="testPaymentOnly()" class="button">Test Payment Only</button>
    
    <h2>Direct Links (use after authentication):</h2>
    <a href="checkout.php?plan=monthly" class="button">Monthly Checkout</a>
    <a href="checkout.php?plan=yearly" class="button">Yearly Checkout</a>
    <a href="checkout.php?plan=lifetime" class="button">Lifetime Checkout</a>

    <script>
        async function runFullTest() {
            const status = document.getElementById('status');
            status.className = 'debug';
            status.textContent = 'Starting full test...\n';
            
            try {
                // Step 1: Create authentication
                status.textContent += 'Step 1: Creating authentication...\n';
                const authResponse = await fetch('fix-auth.php?plan=yearly');
                const authData = await authResponse.json();
                
                status.textContent += 'Auth Result: ' + JSON.stringify(authData, null, 2) + '\n\n';
                
                if (!authData.step2_auth_after) {
                    status.className = 'debug error';
                    status.textContent += '‚ùå Authentication failed!\n';
                    return;
                }
                
                status.textContent += '‚úÖ Authentication successful!\n\n';
                
                // Step 2: Test payment intent
                status.textContent += 'Step 2: Testing payment intent...\n';
                
                const paymentResponse = await fetch('create-payment-intent.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        plan: 'yearly',
                        email: 'test@browser.com',
                        full_name: 'Browser Test',
                        postcode: 'BR123'
                    })
                });
                
                status.textContent += 'Payment Response Status: ' + paymentResponse.status + '\n';
                
                const paymentText = await paymentResponse.text();
                status.textContent += 'Payment Response: ' + paymentText + '\n\n';
                
                if (paymentResponse.ok) {
                    status.className = 'debug success';
                    status.textContent += 'üéâ FULL TEST SUCCESSFUL!\n';
                    status.textContent += 'You can now use the checkout pages above.\n';
                } else {
                    status.className = 'debug error';
                    status.textContent += '‚ùå Payment intent failed: ' + paymentResponse.status + '\n';
                }
                
            } catch (error) {
                status.className = 'debug error';
                status.textContent += '‚ùå Test failed: ' + error.message + '\n';
            }
        }
        
        async function testAuthOnly() {
            const status = document.getElementById('status');
            status.className = 'debug';
            status.textContent = 'Testing authentication only...\n';
            
            try {
                const response = await fetch('fix-auth.php?plan=yearly');
                const data = await response.json();
                
                status.textContent += 'Auth Result:\n' + JSON.stringify(data, null, 2) + '\n';
                
                if (data.step2_auth_after) {
                    status.className = 'debug success';
                    status.textContent += '\n‚úÖ Authentication working!\n';
                } else {
                    status.className = 'debug error';
                    status.textContent += '\n‚ùå Authentication failed!\n';
                }
            } catch (error) {
                status.className = 'debug error';
                status.textContent += '‚ùå Auth test failed: ' + error.message + '\n';
            }
        }
        
        async function testAuthEndpoint() {
            const status = document.getElementById('status');
            status.className = 'debug';
            status.textContent = 'Testing auth endpoint (same check as payment intent)...\n';
            
            try {
                const response = await fetch('test-auth-only.php', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                status.textContent += 'Auth Endpoint Status: ' + response.status + '\n';
                
                const text = await response.text();
                status.textContent += 'Auth Endpoint Response: ' + text + '\n';
                
                if (response.ok) {
                    status.className = 'debug success';
                    status.textContent += '\n‚úÖ Auth endpoint working!\n';
                } else {
                    status.className = 'debug error';
                    status.textContent += '\n‚ùå Auth endpoint failed - same issue as payment intent!\n';
                }
            } catch (error) {
                status.className = 'debug error';
                status.textContent += '‚ùå Auth endpoint test failed: ' + error.message + '\n';
            }
        }
        
        async function testPaymentOnly() {
            const status = document.getElementById('status');
            status.className = 'debug';
            status.textContent = 'Testing payment intent only...\n';
            
            try {
                const response = await fetch('create-payment-intent.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        plan: 'yearly',
                        email: 'test@browser.com',
                        full_name: 'Browser Test',
                        postcode: 'BR123'
                    })
                });
                
                status.textContent += 'Response Status: ' + response.status + '\n';
                
                const text = await response.text();
                status.textContent += 'Response: ' + text + '\n';
                
                if (response.ok) {
                    status.className = 'debug success';
                    status.textContent += '\n‚úÖ Payment intent working!\n';
                } else {
                    status.className = 'debug error';
                    status.textContent += '\n‚ùå Payment intent failed!\n';
                }
            } catch (error) {
                status.className = 'debug error';
                status.textContent += '‚ùå Payment test failed: ' + error.message + '\n';
            }
        }
    </script>
</body>
</html>
